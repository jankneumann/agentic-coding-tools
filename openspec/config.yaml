schema: feature-workflow

context: |
  Project: agentic-coding-tools â€” systems for coordinating and enhancing AI coding agents.
  Primary components: Agent Coordinator (multi-agent MCP server), OpenSpec (spec-driven workflow).
  Tech stack: Python 3.11+, FastMCP, FastAPI, Supabase (PostgreSQL), Docker.
  Architecture: Layered (Execution -> Coordination -> Trust -> Governance).
  Testing: pytest (unit/integration), mypy (types), ruff (linting), Playwright (E2E).
  Agent types: Local (Claude Code CLI, Codex, Aider) via MCP stdio; Cloud via HTTP API.
  Git workflow: Feature branches as openspec/<change-id>, squash merge to main.
  Parallelization: Task() agents with file-scope isolation; no git worktrees needed.
  Environment: uv for Python dependency management across all subprojects.

rules:
  exploration:
    - Gather context from existing specs (openspec list --specs), active changes (openspec list), and codebase search
    - Check architecture artifacts (.architecture/architecture.summary.json) for cross-layer flows and impact
    - Identify related active proposals that might conflict
    - Produce structured context synthesis, not free-form notes
    - Include parallel modification zones from .architecture/parallel_zones.json

  proposal:
    - Include rollback plan for breaking changes (marked with **BREAKING**)
    - Reference affected architecture layers (Execution, Coordination, Trust, Governance)
    - Keep scope to single-capability changes when possible
    - Impact section must list every affected spec capability with corresponding delta file
    - Use verb-led change-id in kebab-case (add-, update-, remove-, refactor-)

  specs:
    - Use WHEN/THEN/AND format for all scenarios (not Given/When/Then)
    - Use #### Scenario: header format (4 hashtags, never bullets or bold)
    - Every requirement must have at least one success and one failure/edge scenario
    - Use SHALL/MUST for normative requirements (avoid should/may)
    - One spec delta file per affected capability under specs/<capability>/spec.md

  design:
    - Only create when change is cross-cutting, introduces new patterns, or has security/performance complexity
    - Include alternatives considered for each decision
    - Address migration and rollback strategy
    - Reference architecture.summary.json for existing component relationships
    - Include sequence diagrams for cross-layer flows

  tasks:
    - Each task must be single-commit sized, atomic, and independently testable
    - Every task must declare explicit file scope (Files: list) for parallel execution safety
    - Tasks with overlapping file scope must have explicit Dependencies annotations
    - Group tasks to maximize parallel execution width
    - Every task must trace to at least one requirement; every requirement to at least one task

  plan-findings:
    - Use tabular format with columns: #, Type, Criticality, Description, Resolution
    - Finding types: completeness, clarity, feasibility, scope, consistency, testability, parallelizability
    - Criticality levels: critical > high > medium > low
    - Each iteration appends a new section with timestamp
    - Include parallelizability assessment (independent tasks, sequential chains, max parallel width)

  impl-findings:
    - Use tabular format with columns: #, Type, Criticality, Description, Resolution
    - Finding types: bug, edge-case, workflow, performance, UX
    - Criticality levels: critical > high > medium > low
    - Each iteration appends a new section with timestamp
    - Flag out-of-scope findings for follow-up proposals

  architecture-impact:
    - Run make architecture-diff BASE_SHA=<merge-base> to compare structural changes against main
    - Run make architecture-validate scoped to changed files for flow validation
    - Report new/broken cross-layer flows, new cycles, and new high-impact nodes
    - Identify affected parallel zones and whether previously independent zones merged
    - If .architecture/ artifacts are stale (older than implementation commits), run make architecture first
    - Include clear recommendation: safe to merge, needs investigation, or blocking issues

  validation-report:
    - Cover all phases: Deploy, Smoke, E2E, Architecture, Spec Compliance, Logs, CI/CD
    - Use symbols: pass, fail, warn, skip for phase results
    - Include commit SHA, branch name, and timestamp
    - Record per-scenario pass/fail for spec compliance phase
    - Include overall PASS/FAIL determination with next-step guidance

  deferred-tasks:
    - Reference original change-id and task number for traceability
    - Include migration target (Beads issue ID or follow-up proposal change-id)
    - Preserve original file scope and dependency context from tasks.md
    - Record migration date and reason for deferral
